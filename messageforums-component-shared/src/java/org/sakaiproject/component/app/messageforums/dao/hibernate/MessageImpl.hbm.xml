<?xml version="1.0"?>
<!DOCTYPE hibernate-mapping
    PUBLIC "-//Hibernate/Hibernate Mapping DTD//EN"
    "http://hibernate.sourceforge.net/hibernate-mapping-2.0.dtd">

<hibernate-mapping>

  <class 
      name="org.sakaiproject.component.app.messageforums.dao.hibernate.MessageImpl"
      table="MFR_MESSAGE_T" 
      optimistic-lock="version" 
      discriminator-value="ME">
    
    <!-- Inherited fields from MutableEntity -->
    <id name="id">
      <column name="ID" not-null="true" length="19" />
      <generator class="native">
        <param name="sequence">MFR_MESSAGE_S</param>
      </generator>
    </id>

	<!--  Discriminator field used for polymophism in the database -->
    <discriminator column="MESSAGE_DTYPE" type="string" length="2" />
       
	<!--  Version number used for optimistic locking -->
    <version name="version" column="VERSION" />

    <property name="uuid" column="UUID" length="36" not-null="true" />
    <property name="created" column="CREATED" not-null="true" />
    <property name="createdBy" column="CREATED_BY" length="36" not-null="true" />
    <property name="modified" column="MODIFIED" not-null="true" />
    <property name="modifiedBy" column="MODIFIED_BY" length="36" not-null="true" />

    <!-- Message fields -->
    <property name="title">
      <column name="TITLE" length="255" not-null="true" />
    </property>
    <property name="body" type="text">
      <column name="BODY" not-null="true" />
    </property>
    <property name="author">
      <column name="AUTHOR" length="255" not-null="true" />
    </property>
    <set name="attachments" lazy="true" sort="natural" 
         order-by="attachmentName asc" cascade="all">
        <key column="surrogateKey"/>                        
        <one-to-many class="org.sakaiproject.component.app.messageforums.dao.hibernate.Attachment"/>            
    </set>
    <property name="label">
      <column name="LABEL" length="255" not-null="false" />
    </property>
    <many-to-one name="inReplyTo" column="IN_REPLY_TO"
      class="org.sakaiproject.component.app.messageforums.dao.hibernate.MessageImpl"
      not-null="false" cascade="none" />        
    <property name="gradebook">
      <column name="GRADEBOOK" length="255" not-null="false" />
    </property>    
    <property name="gradebookAssignment">
      <column name="GRADEBOOK_ASSIGNMENT" length="255" not-null="false" />
    </property>
    <many-to-one name="type" column="TYPE"
      class="org.sakaiproject.component.app.messageforums.dao.hibernate.Type"
      not-null="false" cascade="none" />    
    <property name="approved">
      <column name="APPROVED" not-null="true" />
    </property>
    <property name="draft">
      <column name="DRAFT" not-null="true" />
    </property>
        
    <!-- PrivateMessage fields -->
    <subclass 
      name="org.sakaiproject.component.app.messageforums.dao.hibernate.PrivateMessage"
      discriminator-value="PM">
      <set name="recipients" lazy="true" sort="natural"
           order-by="surname asc" cascade="all-delete-orphan">
          <key column="surrogateKey"/>                        
          <one-to-many class="org.sakaiproject.component.app.messageforums.dao.hibernate.MessageForumsUserImpl"/>            
      </set>     
      <property name="externalEmail">
        <column name="EXTERNAL_EMAIL" not-null="false" />
      </property>        
      <property name="externalEmailAddress">
        <column name="EXTERNAL_EMAIL_ADDRESS" length="255" not-null="false" />
      </property>
    </subclass>
    
  </class>

  <query name="findMessageById">
    <![CDATA[from org.sakaiproject.component.app.messageforums.dao.hibernate.MessageImpl as message where message.id = :id]]>
  </query>

  <query name="findMessageByUuid">
    <![CDATA[from org.sakaiproject.component.app.messageforums.dao.hibernate.MessageImple as message where message.uuid = :uuid]]>
  </query>

</hibernate-mapping>